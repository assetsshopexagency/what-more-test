<!-- extensions/video-carousel/blocks/video-carousel.liquid -->
<div class="video-carousel" data-shop="{{ shop.permanent_domain }}">
  <div class="loading" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading videos...</p>
  </div>

  <div class="carousel-container" id="carouselContainer" style="display: none;">
    <div class="videos-grid" id="videosGrid"></div>
  </div>

  <div class="empty-state" id="emptyState" style="display: none;">
    <div class="empty-icon">üìπ</div>
    <p>No videos available</p>
  </div>

  <div class="error-state" id="errorState" style="display: none;">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p>Failed to load working</p>
    <button class="retry-button" onclick="loadVideos()">Try Again</button>
  </div>
</div>

<style>
/* Your CSS styles here */
.video-carousel {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
  background: #000;
  min-height: 400px;
}

.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 400px;
  color: white;
  text-align: center;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #333;
  border-top: 4px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.carousel-container {
  width: 100%;
}

.videos-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2rem;
  padding: 1rem;
}

.video-card {
  background: #111;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.video-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
}

.video-player {
  width: 100%;
  height: 250px;
  object-fit: cover;
  background: #000;
  display: block;
}

.video-info {
  padding: 1.5rem;
  color: white;
}

.video-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 0.5rem 0;
  line-height: 1.3;
}

.video-description {
  font-size: 14px;
  color: #ccc;
  margin: 0;
  line-height: 1.4;
}

.empty-state, .error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 400px;
  color: white;
  text-align: center;
}

.empty-icon, .error-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.retry-button {
  background: #fff;
  color: #000;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 1rem;
}

.retry-button:hover {
  background: #f0f0f0;
}

@media (max-width: 767px) {
  .video-carousel { padding: 1rem; }
  .videos-grid { grid-template-columns: 1fr; gap: 1.5rem; }
  .video-player { height: 200px; }
  .video-info { padding: 1rem; }
}

@media (min-width: 768px) {
  .videos-grid { grid-template-columns: repeat(4, 1fr); }
}
</style>

<script>
const APP_NAME = 'EE-Watch'; // Use your app name

async function loadVideos() {
  const shop = document.querySelector('.video-carousel').dataset.shop;
  const loadingState = document.getElementById('loadingState');
  const carouselContainer = document.getElementById('carouselContainer');
  const emptyState = document.getElementById('emptyState');
  const errorState = document.getElementById('errorState');
  
  // Show loading, hide others
  loadingState.style.display = 'flex';
  carouselContainer.style.display = 'none';
  emptyState.style.display = 'none';
  errorState.style.display = 'none';

  try {
    const response = await fetch(
      `/apps/${APP_NAME}/carousel-videos?shop=${encodeURIComponent(shop)}`,
      {
        credentials: 'include'
      }
    );

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    if (data.success && data.videos && data.videos.length > 0) {
      renderVideos(data.videos);
      carouselContainer.style.display = 'block';
    } else {
      emptyState.style.display = 'flex';
    }
  } catch (error) {
    console.error('Error loading videos:', error);
    errorState.style.display = 'flex';
  } finally {
    loadingState.style.display = 'none';
  }
}

function renderVideos(videos) {
  const videosGrid = document.getElementById('videosGrid');
  let videosHTML = '';
  
  // Display only first 4 videos
  const videosToShow = videos.slice(0, 4);
  
  videosToShow.forEach((video, index) => {
    videosHTML += `
      <div class="video-card">
        <video
          class="video-player"
          src="${video.shopify_file_url}"
          loop
          muted
          playsinline
          controls
          poster="https://via.placeholder.com/300x250/333/fff?text=Video+${index + 1}"
        ></video>
        <div class="video-info">
          <div class="video-title">${video.title || `Video ${index + 1}`}</div>
          ${video.description ? `<div class="video-description">${video.description}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  videosGrid.innerHTML = videosHTML;
  
  // Add auto-play to first video
  const firstVideo = videosGrid.querySelector('video');
  if (firstVideo) {
    firstVideo.play().catch(e => console.log('Autoplay blocked, user interaction required'));
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', loadVideos);
</script>

{% schema %}
{
  "name": "Video Carousel Grid",
  "target": "section",
  "settings": [],
  "enabled_on": {
    "templates": ["*"],
    "groups": ["*"]
  }
}
{% endschema %}