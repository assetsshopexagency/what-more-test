<!-- video-carousel.liquid -->
<div class="video-carousel" data-shop="{{ shop.permanent_domain }}">
  <!-- Header -->
  <div class="carousel-header">
    <h2 class="section-title">Watch and Shop</h2>
    <button class="saved-videos-btn" onclick="openSavedVideos()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
      </svg>
      Saved Videos
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading videos...</p>
  </div>
  
  <!-- Main Carousel -->
  <div class="carousel-container" id="carouselContainer" style="display: none;">
    <button class="nav-btn prev-btn" onclick="showPreviousVideos()" aria-label="Previous videos">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <div class="videos-grid" id="videosGrid"></div>
    
    <button class="nav-btn next-btn" onclick="showNextVideos()" aria-label="Next videos">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Empty State -->
  <div class="empty-state" id="emptyState" style="display: none;">
    <div class="empty-icon">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="2" y="5" width="20" height="14" rx="2"></rect>
        <polyline points="2,10 12,15 22,10"></polyline>
      </svg>
    </div>
    <h3>No videos available</h3>
    <p>Upload videos from your app dashboard</p>
  </div>

  <!-- Error State -->
  <div class="error-state" id="errorState" style="display: none;">
    <div class="error-icon">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <h3>Failed to load videos</h3>
    <p id="errorMessage">Please try again</p>
    <button class="retry-btn" onclick="loadVideos()">Try Again</button>
  </div>
</div>

<!-- Modal Carousel Viewer -->
<div class="modal-carousel" id="modalCarousel" style="display: none;">
  <div class="modal-background" onclick="closeModalCarousel()"></div>
  
  <div class="modal-content">
    <!-- Close Button -->
    <button class="modal-close-btn" onclick="closeModalCarousel()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <!-- Main Carousel Container -->
    <div class="modal-carousel-container">
      <!-- Previous Video Preview -->
      <div class="video-preview prev-video" id="prevVideoPreview" onclick="showPrevModalVideo()">
        <div class="preview-overlay"></div>
        <video class="preview-video" muted playsinline loop></video>
        <div class="preview-arrow">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M15 18L9 12L15 6"/>
          </svg>
        </div>
      </div>
      
      <!-- Main Video Container -->
      <div class="modal-video-container">
        <!-- Main Video Player -->
        <div class="modal-video-wrapper">
          <video 
            class="modal-video-player"
            id="modalVideoPlayer"
            muted
            playsinline
            autoplay
            onclick="toggleModalVideoPlayPause(this)"
          ></video>
          
          <!-- Progress Bar -->
          <div class="video-progress-container">
            <div class="video-progress-bar" id="videoProgressBar">
              <div class="video-progress-fill" id="videoProgressFill"></div>
            </div>
          </div>
          
          <!-- Volume Control -->
          <div class="modal-volume-control">
            <button class="volume-btn" onclick="toggleModalMute(this)">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <polygon points="11,5 6,9 2,9 2,15 6,15 11,19 11,5"></polygon>
                <path d="M19.07,4.93a10,10,0,0,1,0,14.14M15.54,8.46a5,5,0,0,1,0,7.07" class="volume-high"></path>
                <line x1="23" y1="1" x2="1" y2="23" class="volume-mute" style="display: none;"></line>
              </svg>
            </button>
          </div>
          
          <!-- Download Control -->
          <div class="modal-download-control">
            <button class="download-control-btn" onclick="downloadModalVideo()">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M21,15v4a2,2,0,0,1-2,2H5a2,2,0,0,1-2-2V15"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
          </div>
          
          <!-- Product Carousel -->
          <div class="product-carousel" id="modalProductCarousel"></div>
          
          <!-- Engagement Buttons -->
          <div class="modal-engagement-buttons">
            <button class="engagement-btn like-btn" id="modalLikeBtn" onclick="toggleModalLike()">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M20.84,4.61a5.5,5.5,0,0,0-7.78,0L12,5.67l-1.06-1.06a5.5,5.5,0,0,0-7.78,7.78l1.06,1.06L12,21.23l7.78-7.78,1.06-1.06a5.5,5.5,0,0,0,0-7.78Z"/>
              </svg>
              <span class="engagement-count" id="modalLikeCount">0</span>
            </button>
            
            <button class="engagement-btn comment-btn" onclick="openModalComments()">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M21,11.5a8.38,8.38,0,0,1-.9,3.8,8.5,8.5,0,0,1-7.6,4.7,8.38,8.38,0,0,1-3.8-.9L3,21l1.9-5.7a8.38,8.38,0,0,1-.9-3.8,8.5,8.5,0,0,1,4.7-7.6,8.38,8.38,0,0,1,3.8-.9h.5a8.48,8.48,0,0,1,8,8v.5Z"/>
              </svg>
              <span class="engagement-count" id="modalCommentCount">0</span>
            </button>
            
            <button class="engagement-btn save-btn" id="modalSaveBtn" onclick="toggleModalSave()">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="engagement-count" id="modalSaveCount">0</span>
            </button>
            
            <button class="engagement-btn share-btn" onclick="shareModalVideo()">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </svg>
              <span class="engagement-count" id="modalShareCount">0</span>
            </button>
          </div>
          
          <!-- Video Info Overlay -->
          <div class="video-info-overlay">
            <h3 id="modalVideoTitle"></h3>
            <p id="modalVideoDescription"></p>
          </div>
        </div>
      </div>
      
      <!-- Next Video Preview -->
      <div class="video-preview next-video" id="nextVideoPreview" onclick="showNextModalVideo()">
        <div class="preview-overlay"></div>
        <video class="preview-video" muted playsinline loop></video>
        <div class="preview-arrow">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9 18L15 12L9 6"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Comments Section -->
<div class="comments-section" id="commentsSection" style="display: none;">
  <div class="comments-header">
    <h3>Comments</h3>
    <button class="close-comments" onclick="closeComments()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  <div class="comments-list" id="commentsList">
    <!-- Comments will be loaded here -->
  </div>
  <div class="add-comment">
    <input type="text" id="commentInput" placeholder="Add a comment..." class="comment-input">
    <button onclick="postComment()" class="post-comment-btn">Post</button>
  </div>
</div>

<!-- Saved Videos Modal -->
<div class="saved-videos-modal" id="savedVideosModal" style="display: none;">
  <div class="modal-background" onclick="closeSavedVideos()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Your Saved Videos</h3>
      <button class="close-modal" onclick="closeSavedVideos()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="saved-videos-list" id="savedVideosList">
      <!-- Saved videos will be loaded here -->
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" style="display: none;">
  <div class="modal-background" onclick="closeShareModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Share this video</div>
      <button class="close-button" onclick="closeShareModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="share-url-container">
        <input type="text" class="share-url-input" id="shareUrlInput" readonly>
        <button class="copy-button" onclick="copyShareUrl()">Copy</button>
      </div>
      <div class="share-options">
        <button class="share-option" onclick="shareToFacebook()">
          <div class="share-icon facebook">f</div>
          <span>Facebook</span>
        </button>
        <button class="share-option" onclick="shareToTwitter()">
          <div class="share-icon twitter">t</div>
          <span>Twitter</span>
        </button>
        <button class="share-option" onclick="shareToWhatsApp()">
          <div class="share-icon whatsapp">W</div>
          <span>WhatsApp</span>
        </button>
        <button class="share-option" onclick="shareToLinkedIn()">
          <div class="share-icon linkedin">in</div>
          <span>LinkedIn</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Base Styles */
  .video-carousel {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 3rem 1rem;
    background: #fff;
    position: relative;
  }

  .carousel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 0 1rem;
  }

  .section-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #000;
    margin: 0;
  }

  .saved-videos-btn {
    background: #000;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .saved-videos-btn:hover {
    background: #333;
    transform: translateY(-1px);
  }

  /* Loading, Empty, Error States */
  .loading, .empty-state, .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: #666;
    text-align: center;
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(0,0,0,0.1);
    border-radius: 50%;
    border-top-color: #000;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Main Carousel */
  .carousel-container {
    width: 100%;
    position: relative;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0 1rem;
  }

  .videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    flex: 1;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 1rem 0;
    scrollbar-width: thin;
  }

  .videos-grid::-webkit-scrollbar {
    height: 6px;
  }

  .videos-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .videos-grid::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .videos-grid::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .nav-btn {
    background: #fff;
    border: 2px solid #e5e5e5;
    color: #000;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-shrink: 0;
    z-index: 10;
  }

  .nav-btn:hover:not(:disabled) {
    background: #f8f8f8;
    border-color: #000;
    transform: scale(1.05);
  }

  .nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Video Card */
  .video-card {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid #f0f0f0;
    position: relative;
    aspect-ratio: 9/16;
    cursor: pointer;
    height: 450px;
    min-width: 250px;
  }

  .video-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  }

  .video-player-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    border-radius: 12px;
  }

  .video-player {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
    border-radius: 12px;
  }

  .video-card:hover .video-player {
    transform: scale(1.05);
  }

  /* Modal Carousel Styles */
  .modal-carousel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
  }

  .modal-content {
    position: relative;
    width: 95%;
    height: 95vh;
    background: none;
    border-radius: 0;
    overflow: hidden;
    z-index: 1001;
  }

  .modal-close-btn {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: none;
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1002;
    transition: all 0.3s ease;
  }

  .modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
  }

  .modal-carousel-container {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    height: 100%;
    width: 100%;
    gap: 2rem;
  }

  /* Video Preview Styles */
  .video-preview {
    width: 25%;
    height: 70vh;
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
    opacity: 0.6;
    cursor: pointer;
  }

  .video-preview:hover {
    opacity: 0.8;
    transform: scale(1.02);
  }

  .prev-video {
    order: 1;
  }

  .next-video {
    order: 3;
  }

  .preview-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 16px;
  }

  .preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 16px;
  }

  .preview-arrow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Main Video Container */
  .modal-video-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    width: 50%;
    order: 2;
  }

  .modal-video-wrapper {
    position: relative;
    width: 100%;
    height: 80vh;
    background: none;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .modal-video-player {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    border-radius: 20px;
  }

  /* Progress Bar Styles */
  .video-progress-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 10;
  }

  .video-progress-bar {
    width: 100%;
    height: 100%;
    background: transparent;
    position: relative;
  }

  .video-progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: white;
    width: 0%;
    transition: width 0.1s linear;
  }

  /* Controls */
  .modal-volume-control,
  .modal-download-control {
    position: absolute;
    top: 20px;
    z-index: 10;
  }

  .modal-volume-control {
    left: 20px;
  }

  .modal-download-control {
    right: 20px;
  }

  .volume-btn,
  .download-control-btn {
    background: none;
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(0, 0, 0, 0.5);
  }

  .volume-btn:hover,
  .download-control-btn:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
  }

  /* Modal Engagement Buttons */
  .modal-engagement-buttons {
    position: absolute;
    bottom: 40px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: flex-end;
    z-index: 10;
  }

  .engagement-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: transform 0.3s ease;
    padding: 0;
  }

  .engagement-btn:hover {
    transform: scale(1.1);
  }

  .engagement-btn svg {
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    padding: 0.8rem;
    transition: all 0.3s ease;
  }

  .engagement-btn:hover svg {
    background: rgba(0, 0, 0, 0.7);
  }

  .engagement-count {
    font-size: 1rem;
    font-weight: 600;
    color: white;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
  }

  .engagement-btn.active {
    color: #ff0050;
  }

  .engagement-btn.active svg {
    fill: #ff0050;
    stroke: #ff0050;
  }

  .engagement-btn.saved {
    color: #1da1f2;
  }

  .engagement-btn.saved svg {
    fill: #1da1f2;
    stroke: #1da1f2;
  }

  /* Video Info Overlay */
  .video-info-overlay {
    position: absolute;
    bottom: 40px;
    left: 20px;
    max-width: 60%;
    z-index: 10;
    background: rgba(0, 0, 0, 0.7);
    padding: 1rem;
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }

  .video-info-overlay h3 {
    color: white;
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .video-info-overlay p {
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-size: 1rem;
    line-height: 1.4;
  }

  /* Product Carousel Styles */
  .product-carousel {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    overflow-x: auto;
    gap: 0.5rem;
    padding: 0.75rem;
    background: transparent;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.6) transparent;
    z-index: 10;
  }

  .product-carousel::-webkit-scrollbar {
    height: 4px;
  }

  .product-carousel::-webkit-scrollbar-track {
    background: transparent;
  }

  .product-carousel::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.6);
    border-radius: 2px;
  }

  .product-card {
    flex: 0 0 280px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
  }

  .product-card:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: translateY(-2px);
  }

  .product-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
  }

  .product-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .product-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: white;
    margin: 0;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-price {
    font-size: 0.85rem;
    font-weight: 600;
    color: white;
    margin: 0;
  }

  .add-to-cart-btn {
    background: white;
    color: black;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s;
    flex-shrink: 0;
    white-space: nowrap;
  }

  .add-to-cart-btn:hover {
    background: #fa1515;
    color: white;
    transform: translateY(-1px);
  }

  .add-to-cart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Comments Section */
  .comments-section {
    position: fixed;
    right: 0;
    top: 0;
    width: 400px;
    height: 100%;
    background: white;
    z-index: 1002;
    display: flex;
    flex-direction: column;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .comments-section.active {
    transform: translateX(0);
  }

  .comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e5e5;
    background: white;
  }

  .comments-header h3 {
    margin: 0;
    color: #000;
    font-size: 1.2rem;
  }

  .close-comments {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background 0.3s ease;
  }

  .close-comments:hover {
    background: #f5f5f5;
  }

  .comments-list {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #fafafa;
  }

  .comment-item {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }

  .comment-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .comment-author {
    font-weight: 600;
    color: #000;
    font-size: 0.9rem;
  }

  .comment-date {
    color: #666;
    font-size: 0.8rem;
  }

  .comment-text {
    margin: 0;
    color: #333;
    line-height: 1.4;
    font-size: 0.9rem;
  }

  .add-comment {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid #e5e5e5;
    background: white;
  }

  .comment-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #e5e5e5;
    border-radius: 20px;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.3s ease;
  }

  .comment-input:focus {
    border-color: #000;
  }

  .post-comment-btn {
    background: #000;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s ease;
    font-weight: 600;
  }

  .post-comment-btn:hover {
    background: #333;
  }

  /* Modals */
  .saved-videos-modal,
  .share-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .saved-videos-modal.active,
  .share-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .saved-videos-modal .modal-content,
  .share-modal .modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .saved-videos-modal.active .modal-content,
  .share-modal.active .modal-content {
    transform: scale(1);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e5e5;
  }

  .modal-header h3 {
    margin: 0;
    color: #000;
  }

  .close-modal,
  .close-button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background 0.3s ease;
    font-size: 1.5rem;
    color: #666;
  }

  .close-modal:hover,
  .close-button:hover {
    background: #f5f5f5;
  }

  /* Share Modal */
  .share-modal .modal-content {
    background-color: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .modal-body {
    padding: 20px 24px;
  }

  .share-url-container {
    display: flex;
    margin-bottom: 24px;
  }

  .share-url-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 8px 0 0 8px;
    font-size: 14px;
    outline: none;
  }

  .copy-button {
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-left: none;
    border-radius: 0 8px 8px 0;
    padding: 0 16px;
    cursor: pointer;
    font-weight: 600;
    color: #333;
    transition: background-color 0.2s;
  }

  .copy-button:hover {
    background-color: #e5e5e5;
  }

  .share-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .share-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 12px 8px;
    border-radius: 8px;
    transition: background-color 0.2s;
    background: none;
    border: 1px solid #eee;
  }

  .share-option:hover {
    background-color: #f9f9f9;
  }

  .share-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 8px;
    font-size: 18px;
    color: white;
    font-weight: bold;
  }

  .share-option span {
    font-size: 12px;
    color: #555;
    text-align: center;
  }

  /* Platform-specific colors */
  .facebook { background-color: #1877f2; }
  .twitter { background-color: #1da1f2; }
  .whatsapp { background-color: #25d366; }
  .linkedin { background-color: #0a66c2; }

  /* Saved Videos List */
  .saved-videos-list {
    padding: 1rem;
    max-height: 60vh;
    overflow-y: auto;
  }

  .saved-video-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    transition: background 0.3s ease;
    cursor: pointer;
    border: 1px solid #f0f0f0;
    margin-bottom: 0.5rem;
  }

  .saved-video-item:hover {
    background: #f5f5f5;
  }

  .saved-video-thumbnail {
    width: 80px;
    height: 120px;
    border-radius: 8px;
    object-fit: cover;
    background: #000;
  }

  .saved-video-info {
    flex: 1;
  }

  .saved-video-title {
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #000;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .video-carousel {
      max-width: 100%;
      padding: 2rem 0.5rem;
    }
    
    .modal-carousel-container {
      gap: 1rem;
    }
    
    .video-preview {
      width: 20%;
    }

    .modal-video-container {
      width: 60%;
    }
  }

  @media (max-width: 900px) {
    .section-title {
      font-size: 2rem;
    }
    
    .videos-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .video-card {
      height: 350px;
      min-width: 200px;
    }
    
    .modal-carousel-container {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .video-preview {
      display: none;
    }
    
    .modal-video-container {
      width: 100%;
      height: 60vh;
    }
    
    .modal-video-wrapper {
      height: 60vh;
    }
    
    .modal-engagement-buttons {
      bottom: 20px;
      right: 10px;
      gap: 1rem;
    }
    
    .engagement-btn svg {
      width: 35px;
      height: 35px;
      padding: 0.6rem;
    }
    
    .product-carousel {
      padding: 0.5rem;
    }
    
    .product-card {
      flex: 0 0 220px;
      padding: 0.5rem;
    }
    
    .comments-section {
      width: 100%;
    }
  }

  @media (max-width: 600px) {
    .carousel-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
    
    .saved-videos-btn {
      align-self: flex-start;
    }
    
    .videos-grid {
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    
    .video-card {
      height: 300px;
      min-width: 160px;
    }
    
    .nav-btn {
      width: 40px;
      height: 40px;
    }
    
    .modal-close-btn {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
    }
    
    .video-info-overlay {
      max-width: 80%;
      padding: 0.75rem;
    }
    
    .video-info-overlay h3 {
      font-size: 1.2rem;
    }
    
    .video-info-overlay p {
      font-size: 0.9rem;
    }
    
    .engagement-btn svg {
      width: 30px;
      height: 30px;
      padding: 0.5rem;
    }
    
    .engagement-count {
      font-size: 0.8rem;
    }
    
    .product-card {
      flex: 0 0 180px;
    }
    
    .product-image {
      width: 50px;
      height: 50px;
    }
    
    .product-title {
      font-size: 0.8rem;
    }
    
    .product-price {
      font-size: 0.8rem;
    }
    
    .add-to-cart-btn {
      font-size: 0.7rem;
      padding: 0.4rem 0.8rem;
    }
  }
</style>

<script>
  // Global variables
  let allVideos = [];
  let currentPage = 0;
  const VIDEOS_PER_PAGE = 8;
  let currentShareVideo = null;
  let currentCommentsVideo = null;
  let currentModalIndex = 0;
  let progressInterval = null;
  let storeCurrency = 'USD';
  let userId = null;
  
  // Your CloudFlare URL
  const CLOUDFLARE_URL = 'https://spears-second-rack-indie.trycloudflare.com';
  
  // Initialize the carousel
  async function loadVideos() {
    const shop = document.querySelector('.video-carousel').dataset.shop;
    const loadingState = document.getElementById('loadingState');
    const carouselContainer = document.getElementById('carouselContainer');
    const emptyState = document.getElementById('emptyState');
    const errorState = document.getElementById('errorState');

    // Show loading, hide others
    loadingState.style.display = 'flex';
    carouselContainer.style.display = 'none';
    emptyState.style.display = 'none';
    errorState.style.display = 'none';

    try {
      console.log('üîÑ Fetching videos...');
      
      // Get user ID
      userId = getUserId();
      console.log('üë§ User ID:', userId);
      
      // Build API URL
      const url = `${CLOUDFLARE_URL}/api/videos?shop=${encodeURIComponent(shop)}`;
      console.log('üì° Calling API:', url);
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`API returned ${response.status}`);
      }

      const data = await response.json();
      console.log('üì¶ API Response:', data);

      if (data.success && data.videos && data.videos.length > 0) {
        // Transform your API response - ensure we have the video ID
        allVideos = data.videos.map(video => ({
          id: video.id, // This is the VIDEO ID for products API
          title: video.title,
          description: video.description,
          shopify_file_url: video.shopify_file_id 
            ? `${CLOUDFLARE_URL}/api/video-proxy/${encodeURIComponent(video.shopify_file_id)}`
            : video.video_url || video.shopify_file_url || '',
          thumbnail_url: video.thumbnail_url,
          duration: video.duration,
          created_at: video.created_at,
          like_count: video.like_count || 0,
          comment_count: video.comment_count || 0,
          save_count: video.save_count || 0,
          share_count: video.share_count || 0,
          download_count: video.download_count || 0,
          user_has_liked: video.user_has_liked || false,
          user_has_saved: video.user_has_saved || false,
          original_data: video // Keep all original data
        }));
        
        console.log(`‚úÖ Loaded ${allVideos.length} videos`);
        console.log('üìπ Sample video data:', allVideos[0]);
        
        storeCurrency = data.store_currency || 'USD';
        currentPage = 0;
        renderCurrentVideos();
        updateNavigation();
        carouselContainer.style.display = 'flex';
      } else {
        emptyState.style.display = 'flex';
      }

    } catch (error) {
      console.error('‚ùå Error loading videos:', error);
      document.getElementById('errorMessage').textContent = error.message;
      errorState.style.display = 'flex';
    } finally {
      loadingState.style.display = 'none';
    }
  }

  // Render videos in carousel
  function renderCurrentVideos() {
    const videosGrid = document.getElementById('videosGrid');
    let videosHTML = '';

    const startIndex = currentPage * VIDEOS_PER_PAGE;
    const endIndex = startIndex + VIDEOS_PER_PAGE;
    const videosToShow = allVideos.slice(startIndex, endIndex);
    
    videosToShow.forEach((video, index) => {
      const globalIndex = startIndex + index;
      
      videosHTML += `
        <div class="video-card" onclick="openModalCarousel(${globalIndex})">
          <div class="video-player-container">
            <video 
              class="video-player"
              src="${video.shopify_file_url}"
              loop
              muted
              playsinline
              autoplay
              poster="${video.thumbnail_url || 'https://via.placeholder.com/300x533/333/fff?text=Video'}"
              data-video-id="${video.id}"
              preload="metadata"
            ></video>
          </div>
        </div>
      `;
    });

    videosGrid.innerHTML = videosHTML;
  }

  // Modal Carousel Functions
  function openModalCarousel(startIndex) {
    currentModalIndex = startIndex;
    const modal = document.getElementById('modalCarousel');
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    loadModalVideo(currentModalIndex);
  }

  function closeModalCarousel() {
    const modal = document.getElementById('modalCarousel');
    const videoPlayer = document.getElementById('modalVideoPlayer');
    
    if (videoPlayer) {
      videoPlayer.pause();
      videoPlayer.src = '';
      videoPlayer.removeEventListener('ended', handleVideoEnded);
      videoPlayer.removeEventListener('timeupdate', updateProgressBar);
    }
    
    // Clear progress interval
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    
    // Reset progress bar
    const progressFill = document.getElementById('videoProgressFill');
    if (progressFill) {
      progressFill.style.width = '0%';
    }
    
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    closeComments();
  }
  
  // FIXED: This function now properly loads videos AND products
  async function loadModalVideo(index) {
    if (index < 0 || index >= allVideos.length) return;
    
    const video = allVideos[index];
    const videoPlayer = document.getElementById('modalVideoPlayer');
    
    console.log('üé¨ Loading modal for video:', video.title);
    console.log('üìπ Video object:', video);
    
    // Clear previous progress interval
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    
    // Reset progress bar
    const progressFill = document.getElementById('videoProgressFill');
    if (progressFill) {
      progressFill.style.width = '0%';
    }
    
    // Update video source
    videoPlayer.src = video.shopify_file_url;
    videoPlayer.muted = true; // Start muted
    
    // Remove loop to allow 'ended' event
    videoPlayer.removeAttribute('loop');
    
    // Add event listeners
    videoPlayer.addEventListener('ended', handleVideoEnded, { once: true });
    videoPlayer.addEventListener('timeupdate', updateProgressBar);
    
    // Update video info
    document.getElementById('modalVideoTitle').textContent = video.title;
    document.getElementById('modalVideoDescription').textContent = video.description || '';
    
    // Update engagement counts
    document.getElementById('modalLikeCount').textContent = video.like_count || 0;
    document.getElementById('modalCommentCount').textContent = video.comment_count || 0;
    document.getElementById('modalSaveCount').textContent = video.save_count || 0;
    document.getElementById('modalShareCount').textContent = video.share_count || 0;
    
    // Update engagement button states
    const likeBtn = document.getElementById('modalLikeBtn');
    const saveBtn = document.getElementById('modalSaveBtn');
    
    if (video.user_has_liked) {
      likeBtn.classList.add('active');
    } else {
      likeBtn.classList.remove('active');
    }
    
    if (video.user_has_saved) {
      saveBtn.classList.add('saved');
    } else {
      saveBtn.classList.remove('saved');
    }
    
    // Load preview videos
    loadPreviewVideos(index);
    
    // FIXED: Get the correct video ID and load products
    const videoId = video.original_data?.id || video.id;
    console.log('üéØ Loading products for video ID:', videoId);
    
    await loadProductsForVideo(videoId);
    
    // Play video with autoplay
    videoPlayer.play().catch(e => {
      console.log('Autoplay blocked:', e);
    });
  }

  // FIXED: This function now properly loads products for a video
  async function loadProductsForVideo(videoId) {
    console.log('üõçÔ∏è loadProductsForVideo called with ID:', videoId);
    
    const productCarousel = document.getElementById('modalProductCarousel');
    if (!productCarousel) {
      console.error('‚ùå Product carousel element not found!');
      return;
    }
    
    try {
      console.log('üõçÔ∏è Loading products for video ID:', videoId);
      
      // Show loading state
      productCarousel.innerHTML = `
        <div style="color: white; text-align: center; padding: 1rem; background: rgba(0,0,0,0.5); border-radius: 8px;">
          <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 0.5rem;"></div>
          <div>Loading products...</div>
        </div>
      `;
      
      const url = `${CLOUDFLARE_URL}/api/video-products/${videoId}`;
      console.log('üì° Fetching from URL:', url);
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`API returned ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('üì¶ API Response:', data);
      
      if (data.success && data.products && data.products.length > 0) {
        console.log(`‚úÖ Found ${data.products.length} products`);
        renderProducts(data.products);
      } else {
        console.log('‚ÑπÔ∏è No products found for this video');
        productCarousel.innerHTML = `
          <div style="color: white; text-align: center; padding: 1rem; background: rgba(0,0,0,0.5); border-radius: 8px;">
            No products associated with this video
          </div>
        `;
      }
      
    } catch (error) {
      console.error('‚ùå Error loading products:', error);
      
      productCarousel.innerHTML = `
        <div style="color: white; text-align: center; padding: 1rem; background: rgba(255,0,0,0.3); border-radius: 8px;">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
          <div>Failed to load products</div>
          <small style="opacity: 0.8;">${error.message}</small>
        </div>
      `;
    }
  }

  // FIXED: This function renders products properly
  function renderProducts(products) {
    const productCarousel = document.getElementById('modalProductCarousel');
    let productsHTML = '';
    
    console.log('üé® Rendering products:', products);
    
    if (!products || products.length === 0) {
      productCarousel.innerHTML = '<div style="color: white; text-align: center; padding: 1rem; background: rgba(0,0,0,0.5); border-radius: 8px;">No products available</div>';
      return;
    }
    
    products.forEach(product => {
      console.log('üì¶ Processing product:', product);
      
      // Handle different possible field names
      const variantId = product.shopify_variant_id || product.variant_id;
      const productId = product.shopify_product_id || product.product_id || product.id;
      const title = product.title || 'Product';
      const price = product.price || '0.00';
      const currencyCode = product.currency_code || storeCurrency;
      const imageUrl = product.image_url || product.image || 'https://via.placeholder.com/60x60/333/fff?text=Image';
      
      // Escape special characters
      const safeTitle = title
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, ' ')
        .trim();
      
      productsHTML += `
        <div class="product-card" 
             data-product-id="${productId}" 
             data-variant-id="${variantId || ''}">
          <img src="${imageUrl}" 
               alt="${title}" 
               class="product-image"
               onerror="this.onerror=null; this.src='https://via.placeholder.com/60x60/333/fff?text=Image';">
          <div class="product-info">
            <h4 class="product-title" title="${title}">${title}</h4>
            <p class="product-price">${formatPrice(price, currencyCode)}</p>
          </div>
          <button class="add-to-cart-btn" 
                  onclick="addToCart('${variantId || ''}', '${safeTitle}')"
                  ${!variantId ? 'disabled' : ''}>
            ${variantId ? 'Add to Cart' : 'No Variant'}
          </button>
        </div>
      `;
    });
    
    productCarousel.innerHTML = productsHTML;
    console.log('‚úÖ Products rendered successfully');
  }

  // Add to cart function
  async function addToCart(variantId, productTitle = 'Product') {
    try {
      console.log('üõí Adding to cart:', variantId, productTitle);
      
      // Clean the variant ID if needed
      let cleanVariantId = variantId;
      
      if (typeof variantId === 'string') {
        // Remove any non-numeric characters
        cleanVariantId = variantId.replace(/\D/g, '');
      }
      
      console.log('üõí Cleaned variantId:', cleanVariantId);
      
      if (!cleanVariantId || cleanVariantId.length < 5) {
        showErrorToast('Invalid product variant. Please try again.');
        return;
      }
      
      const numericVariantId = parseInt(cleanVariantId);
      
      if (isNaN(numericVariantId)) {
        showErrorToast('Invalid product variant ID format.');
        return;
      }
      
      console.log('üõí Final numeric variantId:', numericVariantId);
      
      // Show loading state
      showLoadingMessage('Adding to cart...');
      
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          items: [{ 
            id: numericVariantId, 
            quantity: 1 
          }] 
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå Shopify cart error:', error);
        
        let errorMessage = 'Cannot add to cart: ';
        if (error.description) {
          errorMessage += error.description;
        } else if (error.message) {
          errorMessage += error.message;
        } else {
          errorMessage += 'Product unavailable or out of stock';
        }
        
        showErrorToast(errorMessage);
        return;
      }
      
      const result = await response.json();
      console.log('‚úÖ Added to cart successfully:', result);
      
      showCartSuccessMessage(productTitle);
      
      // Optional: Update cart count in header
      updateCartCount();
      
      setTimeout(() => {
        window.location.href = '/cart';
      }, 1500);
      
    } catch (error) {
      console.error('‚ùå Add to cart error:', error);
      showErrorToast('Network error. Please check your connection and try again.');
    }
  }

  // Helper function to format price
  function formatPrice(price, currencyCode) {
    const numericPrice = parseFloat(price);
    if (isNaN(numericPrice)) {
      return `${currencyCode} 0.00`;
    }
    
    // Format based on currency
    if (currencyCode === 'USD' || currencyCode === 'CAD') {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 2
      }).format(numericPrice);
    } else if (currencyCode === 'EUR') {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 2
      }).format(numericPrice);
    } else if (currencyCode === 'GBP') {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 2
      }).format(numericPrice);
    }
    
    // Default formatting
    return `${currencyCode} ${numericPrice.toFixed(2)}`;
  }

  function updateProgressBar() {
    const videoPlayer = document.getElementById('modalVideoPlayer');
    const progressFill = document.getElementById('videoProgressFill');
    
    if (videoPlayer && progressFill && videoPlayer.duration) {
      const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
      progressFill.style.width = `${progress}%`;
    }
  }

  function loadPreviewVideos(currentIndex) {
    // Previous video
    const prevIndex = (currentIndex - 1 + allVideos.length) % allVideos.length;
    const prevVideo = allVideos[prevIndex];
    const prevPreview = document.getElementById('prevVideoPreview');
    const prevVideoElement = prevPreview.querySelector('.preview-video');
    prevVideoElement.src = prevVideo.shopify_file_url;
    
    // Next video
    const nextIndex = (currentIndex + 1) % allVideos.length;
    const nextVideo = allVideos[nextIndex];
    const nextPreview = document.getElementById('nextVideoPreview');
    const nextVideoElement = nextPreview.querySelector('.preview-video');
    nextVideoElement.src = nextVideo.shopify_file_url;
  }

  function handleVideoEnded() {
    showNextModalVideo();
  }

  function showNextModalVideo() {
    currentModalIndex = (currentModalIndex + 1) % allVideos.length;
    loadModalVideo(currentModalIndex);
  }

  function showPrevModalVideo() {
    currentModalIndex = (currentModalIndex - 1 + allVideos.length) % allVideos.length;
    loadModalVideo(currentModalIndex);
  }

  // Modal Video Controls
  function toggleModalVideoPlayPause(video) {
    if (video.paused) {
      video.play();
    } else {
      video.pause();
    }
  }

  function toggleModalMute(button) {
    const video = document.getElementById('modalVideoPlayer');
    const volumeHigh = button.querySelector('.volume-high');
    const volumeMute = button.querySelector('.volume-mute');
    
    video.muted = !video.muted;
    
    if (video.muted) {
      volumeHigh.style.display = 'none';
      volumeMute.style.display = 'block';
    } else {
      volumeHigh.style.display = 'block';
      volumeMute.style.display = 'none';
    }
  }

  // Engagement Functions
  async function toggleModalLike() {
    const video = allVideos[currentModalIndex];
    const likeBtn = document.getElementById('modalLikeBtn');
    const likeCount = document.getElementById('modalLikeCount');
    const isLiked = likeBtn.classList.contains('active');
    let currentCount = parseInt(likeCount.textContent) || 0;
    
    if (isLiked) {
      likeBtn.classList.remove('active');
      likeCount.textContent = Math.max(0, currentCount - 1);
      video.user_has_liked = false;
      video.like_count = Math.max(0, (video.like_count || 1) - 1);
    } else {
      likeBtn.classList.add('active');
      likeCount.textContent = currentCount + 1;
      video.user_has_liked = true;
      video.like_count = (video.like_count || 0) + 1;
    }
  }

  async function toggleModalSave() {
    const video = allVideos[currentModalIndex];
    const saveBtn = document.getElementById('modalSaveBtn');
    const saveCount = document.getElementById('modalSaveCount');
    const isSaved = saveBtn.classList.contains('saved');
    let currentCount = parseInt(saveCount.textContent) || 0;
    
    if (isSaved) {
      saveBtn.classList.remove('saved');
      saveCount.textContent = Math.max(0, currentCount - 1);
      video.user_has_saved = false;
      video.save_count = Math.max(0, (video.save_count || 1) - 1);
    } else {
      saveBtn.classList.add('saved');
      saveCount.textContent = currentCount + 1;
      video.user_has_saved = true;
      video.save_count = (video.save_count || 0) + 1;
    }
  }

  async function shareModalVideo() {
    const video = allVideos[currentModalIndex];
    const shareCount = document.getElementById('modalShareCount');
    let currentCount = parseInt(shareCount.textContent) || 0;
    
    shareCount.textContent = currentCount + 1;
    video.share_count = (video.share_count || 0) + 1;
    openShareModal(video.id);
  }

  // Download Function
  async function downloadModalVideo() {
    const video = allVideos[currentModalIndex];
    
    try {
      console.log('üì• Starting download for video:', video.title);
      
      // Show downloading state
      showDownloadingMessage();
      
      // Create a temporary anchor element to trigger download
      const link = document.createElement('a');
      link.href = video.shopify_file_url;
      
      // Extract filename
      const filename = getFilenameFromUrl(video.shopify_file_url) || 
                      `${video.title || 'video'}.mp4`;
      
      link.download = filename;
      document.body.appendChild(link);
      
      // Trigger the download
      link.click();
      
      // Clean up
      document.body.removeChild(link);
      
      // Update download count
      video.download_count = (video.download_count || 0) + 1;
      
      // Show success message
      showDownloadSuccessMessage(filename);
      
      console.log('‚úÖ Download completed successfully');
      
    } catch (error) {
      console.error('‚ùå Download error:', error);
      showErrorToast('Failed to download video. Please try again.');
    }
  }

  // Helper function to extract filename from URL
  function getFilenameFromUrl(url) {
    try {
      const urlObj = new URL(url);
      const pathname = urlObj.pathname;
      const filename = pathname.substring(pathname.lastIndexOf('/') + 1);
      
      if (filename && !filename.includes('.')) {
        return `${filename}.mp4`;
      }
      
      return filename || 'video.mp4';
    } catch (error) {
      return 'video.mp4';
    }
  }

  // Show downloading progress message
  function showDownloadingMessage() {
    // Remove any existing messages
    const existingMessages = document.querySelectorAll('.download-message');
    existingMessages.forEach(msg => msg.remove());
    
    const downloadingMsg = document.createElement('div');
    downloadingMsg.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #007bff;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInDown 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      ">
        <div class="download-spinner" style="
          width: 16px;
          height: 16px;
          border: 2px solid transparent;
          border-top: 2px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
        <div>
          <strong>Preparing Download...</strong>
          <div style="font-size: 0.9rem; margin-top: 0.25rem;">Your video will download shortly</div>
        </div>
      </div>
    `;
    
    downloadingMsg.className = 'download-message';
    document.body.appendChild(downloadingMsg);
    
    setTimeout(() => {
      if (document.body.contains(downloadingMsg)) {
        downloadingMsg.remove();
      }
    }, 5000);
  }

  // Show download success message
  function showDownloadSuccessMessage(filename) {
    // Remove downloading message
    const downloadingMsg = document.querySelector('.download-message');
    if (downloadingMsg) {
      downloadingMsg.remove();
    }
    
    // Remove any existing success messages
    const existingMessages = document.querySelectorAll('.download-success-message');
    existingMessages.forEach(msg => msg.remove());
    
    const successMsg = document.createElement('div');
    successMsg.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInDown 0.3s ease;
      ">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 13l4 4L19 7"></path>
          </svg>
          <div>
            <strong>Download Complete!</strong>
            <div style="font-size: 0.9rem; margin-top: 0.25rem;">${filename}</div>
          </div>
        </div>
      </div>
    `;
    
    successMsg.className = 'download-success-message';
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
      if (document.body.contains(successMsg)) {
        successMsg.remove();
      }
    }, 3000);
  }

  function openModalComments() {
    const video = allVideos[currentModalIndex];
    openComments(video.id);
  }

  // Comments System
  function openComments(videoId) {
    currentCommentsVideo = videoId;
    const commentsSection = document.getElementById('commentsSection');
    
    // Simple placeholder comments
    let commentsHTML = `
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">Sample User</span>
          <span class="comment-date">${new Date().toLocaleDateString()}</span>
        </div>
        <p class="comment-text">Love this video! Great content!</p>
      </div>
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">Another User</span>
          <span class="comment-date">${new Date(Date.now() - 86400000).toLocaleDateString()}</span>
        </div>
        <p class="comment-text">Awesome products in this video!</p>
      </div>
    `;
    
    document.getElementById('commentsList').innerHTML = commentsHTML;
    
    commentsSection.style.display = 'flex';
    setTimeout(() => {
      commentsSection.classList.add('active');
    }, 10);
  }

  function closeComments() {
    const commentsSection = document.getElementById('commentsSection');
    commentsSection.classList.remove('active');
    setTimeout(() => {
      commentsSection.style.display = 'none';
    }, 300);
    currentCommentsVideo = null;
  }

  function postComment() {
    const commentInput = document.getElementById('commentInput');
    const comment = commentInput.value.trim();
    
    if (!comment || !currentCommentsVideo) {
      alert('Please enter a comment');
      return;
    }
    
    try {
      const commentsList = document.getElementById('commentsList');
      const newComment = document.createElement('div');
      newComment.className = 'comment-item';
      newComment.innerHTML = `
        <div class="comment-header">
          <span class="comment-author">You</span>
          <span class="comment-date">${new Date().toLocaleDateString()}</span>
        </div>
        <p class="comment-text">${comment}</p>
      `;
      
      commentsList.insertBefore(newComment, commentsList.firstChild);
      commentInput.value = '';
      
      // Update comment count in modal
      const commentCount = document.getElementById('modalCommentCount');
      let currentCount = parseInt(commentCount.textContent) || 0;
      commentCount.textContent = currentCount + 1;
      
      // Update video data
      const video = allVideos.find(v => v.id === currentCommentsVideo);
      if (video) {
        video.comment_count = (video.comment_count || 0) + 1;
      }
      
    } catch (error) {
      console.error('Error posting comment:', error);
      alert('Error posting comment. Please try again.');
    }
  }

  // Helper function to show loading message
  function showLoadingMessage(message) {
    const loadingMsg = document.createElement('div');
    loadingMsg.innerHTML = `
      <div style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 8px;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      ">
        <div class="loading-spinner" style="
          width: 20px;
          height: 20px;
          border: 2px solid transparent;
          border-top: 2px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        "></div>
        <span>${message}</span>
      </div>
    `;
    
    loadingMsg.id = 'cart-loading-message';
    document.body.appendChild(loadingMsg);
    
    // Remove after 5 seconds (safety)
    setTimeout(() => {
      const msg = document.getElementById('cart-loading-message');
      if (msg) msg.remove();
    }, 5000);
  }

  // Helper function to show error toast
  function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
      ">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <div>${message}</div>
        </div>
      </div>
    `;
    
    toast.id = 'error-toast';
    document.body.appendChild(toast);
    
    setTimeout(() => {
      if (document.body.contains(toast)) {
        toast.remove();
      }
    }, 5000);
  }

  // Helper function to show cart success message
  function showCartSuccessMessage(productTitle) {
    const successMsg = document.createElement('div');
    successMsg.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
      ">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 13l4 4L19 7"></path>
          </svg>
          <div>
            <strong>Added to Cart!</strong>
            <div style="font-size: 0.9rem; margin-top: 0.25rem;">${productTitle}</div>
          </div>
        </div>
      </div>
    `;
    
    successMsg.id = 'cart-success-message';
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
      if (document.body.contains(successMsg)) {
        successMsg.remove();
      }
    }, 3000);
  }

  // Utility Functions
  function updateNavigation() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    const totalPages = Math.ceil(allVideos.length / VIDEOS_PER_PAGE);
    
    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage >= totalPages - 1;
  }

  function showNextVideos() {
    const videosGrid = document.getElementById('videosGrid');
    videosGrid.scrollBy({ left: 300, behavior: 'smooth' });
  }

  function showPreviousVideos() {
    const videosGrid = document.getElementById('videosGrid');
    videosGrid.scrollBy({ left: -300, behavior: 'smooth' });
  }

  // Share Modal Functions
  function openShareModal(videoId) {
    currentShareVideo = videoId;
    const modal = document.getElementById('shareModal');
    const shareUrlInput = document.getElementById('shareUrlInput');
    const video = allVideos.find(v => v.id === videoId);
    
    if (video) {
      shareUrlInput.value = `${window.location.origin}#video-${video.id}`;
    } else {
      shareUrlInput.value = window.location.href;
    }
    
    modal.style.display = 'flex';
    setTimeout(() => {
      modal.classList.add('active');
    }, 10);
  }

  function closeShareModal() {
    const modal = document.getElementById('shareModal');
    modal.classList.remove('active');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
    currentShareVideo = null;
  }

  function copyShareUrl() {
    const shareUrlInput = document.getElementById('shareUrlInput');
    shareUrlInput.select();
    shareUrlInput.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(shareUrlInput.value)
      .then(() => {
        const copyButton = document.querySelector('.copy-button');
        const originalText = copyButton.textContent;
        copyButton.textContent = 'Copied!';
        copyButton.style.background = '#28a745';
        copyButton.style.color = 'white';
        
        setTimeout(() => {
          copyButton.textContent = originalText;
          copyButton.style.background = '';
          copyButton.style.color = '';
        }, 2000);
      })
      .catch(() => {
        document.execCommand('copy');
        alert('URL copied to clipboard!');
      });
  }

  // Share functions
  function shareToFacebook() {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(document.getElementById('shareUrlInput').value)}`;
    window.open(url, '_blank');
  }

  function shareToTwitter() {
    const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(document.getElementById('shareUrlInput').value)}&text=Check out this video!`;
    window.open(url, '_blank');
  }

  function shareToWhatsApp() {
    const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(`Check out this video: ${document.getElementById('shareUrlInput').value}`)}`;
    window.open(url, '_blank');
  }

  function shareToLinkedIn() {
    const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(document.getElementById('shareUrlInput').value)}`;
    window.open(url, '_blank');
  }

  // Saved Videos Modal
  function openSavedVideos() {
    const modal = document.getElementById('savedVideosModal');
    modal.style.display = 'flex';
    modal.classList.add('active');

    const savedVideosList = document.getElementById('savedVideosList');
    savedVideosList.innerHTML = `
      <div class="saved-video-item" onclick="openModalCarousel(0)">
        <img src="https://via.placeholder.com/80x120/333/fff?text=Video+1" class="saved-video-thumbnail" alt="Sample Video 1">
        <div class="saved-video-info">
          <h4 class="saved-video-title">Sample Video 1</h4>
        </div>
      </div>
      <div class="saved-video-item" onclick="openModalCarousel(1)">
        <img src="https://via.placeholder.com/80x120/333/fff?text=Video+2" class="saved-video-thumbnail" alt="Sample Video 2">
        <div class="saved-video-info">
          <h4 class="saved-video-title">Sample Video 2</h4>
        </div>
      </div>
      <p style="text-align: center; color: #666; padding: 1rem; font-style: italic;">Save videos to see them here!</p>
    `;
  }

  function closeSavedVideos() {
    const modal = document.getElementById('savedVideosModal');
    modal.classList.remove('active');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }

  // Helper Functions
  function getUserId() {
    {% if customer %}
      return {{ customer.id | json }};
    {% endif %}
    return null;
  }

  // Update cart count
  function updateCartCount() {
    // You can implement this based on your theme
    // Example: document.querySelector('.cart-count').textContent = newCount;
  }

  // Keyboard Navigation
  document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('modalCarousel');
    if (modal.style.display === 'flex') {
      if (e.key === 'ArrowLeft') {
        showPrevModalVideo();
      } else if (e.key === 'ArrowRight') {
        showNextModalVideo();
      } else if (e.key === 'Escape') {
        closeModalCarousel();
      } else if (e.key === ' ') {
        e.preventDefault();
        const videoPlayer = document.getElementById('modalVideoPlayer');
        toggleModalVideoPlayPause(videoPlayer);
      }
    } else {
      if (e.key === 'ArrowLeft') {
        showPreviousVideos();
      } else if (e.key === 'ArrowRight') {
        showNextVideos();
      }
    }
  });

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', loadVideos);

  // Close modals when clicking outside
  document.addEventListener('click', (e) => {
    const shareModal = document.getElementById('shareModal');
    const savedModal = document.getElementById('savedVideosModal');
    
    if (shareModal.style.display === 'flex' && e.target === shareModal.querySelector('.modal-background')) {
      closeShareModal();
    }
    
    if (savedModal.style.display === 'flex' && e.target === savedModal.querySelector('.modal-background')) {
      closeSavedVideos();
    }
  });
</script>

{% schema %}
{
  "name": "Video Carousel Grid",
  "target": "section",
  "settings": [],
  "enabled_on": {
    "templates": ["*"],
    "groups": ["*"]
  }
}
{% endschema %}